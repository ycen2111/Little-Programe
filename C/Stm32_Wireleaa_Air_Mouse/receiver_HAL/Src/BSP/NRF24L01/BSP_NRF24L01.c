
#include "NRF24L01\BSP_NRF24L01.h"
#include "spi.h"
 
const uint8_t TX_ADDRESS[TX_ADR_WIDTH]={0x34,0x43,0x10,0x10,0x01}; //transmiter address
const uint8_t RX_ADDRESS[RX_ADR_WIDTH]={0x34,0x43,0x10,0x10,0x01}; //receiver address
 
//??NRF24L01??SPI1??
void NRF24L01_SPI_Init(void)
{
    __HAL_SPI_DISABLE(&hspi1);               //???SPI1
    hspi1.Init.CLKPolarity=SPI_POLARITY_LOW; //???????????????
    hspi1.Init.CLKPhase=SPI_PHASE_1EDGE;     //????????1????(?????)?????
    HAL_SPI_Init(&hspi1);
    __HAL_SPI_ENABLE(&hspi1);                //??SPI1
}
 
//???24L01?IO?
void NRF24L01_Init(void)
{
    GPIO_InitTypeDef GPIO_Initure;
    __HAL_RCC_GPIOA_CLK_ENABLE();			//开启GPIOA时钟
    __HAL_RCC_GPIOC_CLK_ENABLE();			//开启GPIOC时钟

	//PA4推挽输出
    GPIO_Initure.Pin=GPIO_PIN_4;			//PA4
		GPIO_Initure.Mode=GPIO_MODE_OUTPUT_PP;  //推挽输出
    GPIO_Initure.Pull=GPIO_PULLUP;          //上拉
    GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;//高速
    HAL_GPIO_Init(GPIOA,&GPIO_Initure);     //初始化
	
	//PC4推挽输出
    GPIO_Initure.Pin=GPIO_PIN_4;			//PC4
    HAL_GPIO_Init(GPIOC,&GPIO_Initure);     //初始化
	
	//PA1上拉输入
	GPIO_Initure.Pin=GPIO_PIN_4;			//PA4
	GPIO_Initure.Mode=GPIO_MODE_INPUT;      //输入
	HAL_GPIO_Init(GPIOA,&GPIO_Initure);     //初始化
			
//		MX_SPI1_Init();    		              			//???SPI1
		NRF24L01_SPI_Init();                			//??NRF?????SPI???
		NRF24L01_CE_LOW(); 			            			//??24L01
		NRF24L01_SPI_CS_DISABLE();			    			//SPI????	 		 	 
}
 
/**
	*SPI??????
  *SPI??=fAPB1/????
  *@ref SPI_BaudRate_Prescaler:SPI_BAUDRATEPRESCALER_2~SPI_BAUDRATEPRESCALER_2 256
	*fAPB1?????42Mhz:
	*/
static void SPI1_SetSpeed(uint8_t SPI_BaudRatePrescaler)
{
    assert_param(IS_SPI_BAUDRATE_PRESCALER(SPI_BaudRatePrescaler));//?????
    __HAL_SPI_DISABLE(&hspi1);            //??SPI
    hspi1.Instance->CR1&=0XFFC7;          //?3-5??,???????
    hspi1.Instance->CR1|=SPI_BaudRatePrescaler;//??SPI??
    __HAL_SPI_ENABLE(&hspi1);             //??SPI
}
 
/**
  * ????: ???Flash???????????????????
  * ????: byte:?????
  * ? ? ?: uint8_t:??????
  * ?    ?:?
  */
uint8_t SPIx_ReadWriteByte(SPI_HandleTypeDef* hspi,uint8_t byte)
{
  uint8_t d_read,d_send=byte;
  if(HAL_SPI_TransmitReceive(hspi,&d_send,&d_read,1,0xFF)!=HAL_OK)
  {
    d_read=0xFF;
  }
  return d_read; 
}
 
/**
  * ????: ??24L01????
  * ????: ?
  * ? ? ?: 0,??;1,??
  * ?    ?:?          
  */ 
uint8_t NRF24L01_Check(void)
{
	uint8_t buf[5]={0XA5,0XA5,0XA5,0XA5,0XA5};
	uint8_t i;
  
	SPI1_SetSpeed(SPI_BAUDRATEPRESCALER_8); //spi???8.0Mhz((24L01???SPI???10Mhz,????????)  
	NRF24L01_Write_Buf(NRF_WRITE_REG+TX_ADDR,buf,5);//??5??????.	
	NRF24L01_Read_Buf(TX_ADDR,buf,5); //???????  
	for(i=0;i<5;i++)if(buf[i]!=0XA5)break;	 							   
	if(i!=5)return 1;//??24L01??	
	return 0;		 	//???24L01
}	
 
/**
  * ????: SPI????
  * ????: ?
  * ? ? ?: ?
  * ?    ?:reg:???????
  *           
  */ 
uint8_t NRF24L01_Write_Reg(uint8_t reg,uint8_t value)
{
	uint8_t status;	
  NRF24L01_SPI_CS_ENABLE();                 //??SPI??
  status =SPIx_ReadWriteByte(&hspi1,reg);   //?????? 
  SPIx_ReadWriteByte(&hspi1,value);         //???????
  NRF24L01_SPI_CS_DISABLE();                //??SPI??	   
  return(status);       			//?????
}
 
/**
  * ????: ??SPI????
  * ????: ?
  * ? ? ?: ?
  * ?    ?:reg:??????
  *           
  */ 
uint8_t NRF24L01_Read_Reg(uint8_t reg)
{
	uint8_t reg_val;	    
 	NRF24L01_SPI_CS_ENABLE();          //??SPI??		
  SPIx_ReadWriteByte(&hspi1,reg);   //??????
  reg_val=SPIx_ReadWriteByte(&hspi1,0XFF);//???????
  NRF24L01_SPI_CS_DISABLE();          //??SPI??		    
  return(reg_val);           //?????
}		
 
/**
  * ????: ??????????????
  * ????: ?
  * ? ? ?: ??????????? 
  * ?    ?:?
  *           
  */ 
uint8_t NRF24L01_Read_Buf(uint8_t reg,uint8_t *pBuf,uint8_t len)
{
	uint8_t status,uint8_t_ctr;	   
  
  NRF24L01_SPI_CS_ENABLE();           //??SPI??
  status=SPIx_ReadWriteByte(&hspi1,reg);//??????(??),??????   	   
 	for(uint8_t_ctr=0;uint8_t_ctr<len;uint8_t_ctr++)
  {
    pBuf[uint8_t_ctr]=SPIx_ReadWriteByte(&hspi1,0XFF);//????
  }
  NRF24L01_SPI_CS_DISABLE();       //??SPI??
  return status;        //????????
}
 
/**
  * ????: ?????????????
  * ????: ?
  * ? ? ?: ?
  * ?    ?:reg:???(??)  *pBuf:????  len:????
  *           
  */ 
uint8_t NRF24L01_Write_Buf(uint8_t reg, uint8_t *pBuf, uint8_t len)
{
	uint8_t status,uint8_t_ctr;	    
 	NRF24L01_SPI_CS_ENABLE();          //??SPI??
  status = SPIx_ReadWriteByte(&hspi1,reg);//??????(??),??????
  for(uint8_t_ctr=0; uint8_t_ctr<len; uint8_t_ctr++)
  {
    SPIx_ReadWriteByte(&hspi1,*pBuf++); //????	 
  }
  NRF24L01_SPI_CS_DISABLE();       //??SPI??
  return status;          //????????
}		
 
/**
  * ????: ??NRF24L01??????
  * ????: ?
  * ? ? ?: ??????
  * ?    ?:txbuf:????????
  *           
  */ 
uint8_t NRF24L01_TxPacket(uint8_t *txbuf)
{
	uint8_t sta;
	SPI1_SetSpeed(SPI_BAUDRATEPRESCALER_8); //spi???4.0Mhz(24L01???SPI???10Mhz) 
	NRF24L01_CE_LOW();
  NRF24L01_Write_Buf(WR_TX_PLOAD,txbuf,TX_PLOAD_WIDTH);//????TX BUF  32???
 	NRF24L01_CE_HIGH();//????	 
  
	while(NRF24L01_IRQ_PIN_READ()!=0);//??????
  
	sta=NRF24L01_Read_Reg(STATUS);  //?????????	   
	NRF24L01_Write_Reg(NRF_WRITE_REG+STATUS,sta); //??TX_DS?MAX_RT????
	if(sta&MAX_TX)//????????
	{
		NRF24L01_Write_Reg(FLUSH_TX,0xff);//??TX FIFO??? 
		return MAX_TX; 
	}
	if(sta&TX_OK)//????
	{
		return TX_OK;
	}
	return 0xff;//????????
}
 
/**
  * ????:??NRF24L01??????
  * ????: ?
  * ? ? ?: ?
  * ?    ?:?
  *           
  */ 
uint8_t NRF24L01_RxPacket(uint8_t *rxbuf)
{
	uint8_t sta;		
  SPI1_SetSpeed(SPI_BAUDRATEPRESCALER_8); //spi???4.0Mhz(24L01???SPI???10Mhz) 
	sta=NRF24L01_Read_Reg(STATUS);  //?????????    	 
	NRF24L01_Write_Reg(NRF_WRITE_REG+STATUS,sta); //??TX_DS?MAX_RT????
	if(sta&RX_OK)//?????
	{
		NRF24L01_Read_Buf(RD_RX_PLOAD,rxbuf,RX_PLOAD_WIDTH);//????
		NRF24L01_Write_Reg(FLUSH_RX,0xff);//??RX FIFO??? 
		return 0; 
	}	   
	return 1;//???????
}			
 
/**
  * ????: ??????NRF24L01?RX??
  * ????: ?
  * ? ? ?: ?
  * ?    ?:?
  *           
  */ 
void NRF24L01_RX_Mode(void)
{
	NRF24L01_CE_LOW();	  
  NRF24L01_Write_Reg(NRF_WRITE_REG+CONFIG, 0x0F);//???????????;PWR_UP,EN_CRC,16BIT_CRC 
  NRF24L01_Write_Reg(NRF_WRITE_REG+EN_AA,0x01);    //????0?????    
  NRF24L01_Write_Reg(NRF_WRITE_REG+EN_RXADDR,0x01);//????0?????  	 
  NRF24L01_Write_Reg(NRF_WRITE_REG+RF_CH,40);	     //??RF????		  
  NRF24L01_Write_Reg(NRF_WRITE_REG+RF_SETUP,0x0f);//??TX????,0db??,2Mbps,???????   
  
  NRF24L01_Write_Reg(NRF_WRITE_REG+RX_PW_P0,RX_PLOAD_WIDTH);//????0??????? 	    
    
  NRF24L01_Write_Buf(NRF_WRITE_REG+RX_ADDR_P0,(uint8_t*)RX_ADDRESS,RX_ADR_WIDTH);//?RX????
	
  NRF24L01_CE_HIGH(); //CE??,?????? 
  HAL_Delay(1);
}	
 
/**
  * ????: ??????NRF24L01?TX??
  * ????: ?
  * ? ? ?: ?
  * ?    ?:?
  *           
  */ 
void NRF24L01_TX_Mode(void)
{														 
	NRF24L01_CE_LOW();	    
  NRF24L01_Write_Buf(NRF_WRITE_REG+TX_ADDR,(uint8_t*)TX_ADDRESS,TX_ADR_WIDTH);//?TX???? 
  NRF24L01_Write_Buf(NRF_WRITE_REG+RX_ADDR_P0,(uint8_t*)RX_ADDRESS,RX_ADR_WIDTH); //??TX????,??????ACK	  
 
  NRF24L01_Write_Reg(NRF_WRITE_REG+EN_AA,0x01);     //????0?????    
  NRF24L01_Write_Reg(NRF_WRITE_REG+EN_RXADDR,0x01); //????0?????  
  NRF24L01_Write_Reg(NRF_WRITE_REG+SETUP_RETR,0xff);//??????????:4000us + 86us;????????:15?
  NRF24L01_Write_Reg(NRF_WRITE_REG+RF_CH,40);       //??RF???40
  NRF24L01_Write_Reg(NRF_WRITE_REG+RF_SETUP,0x0f);  //??TX????,0db??,2Mbps,???????   
  NRF24L01_Write_Reg(NRF_WRITE_REG+CONFIG,0x0e);    //???????????;PWR_UP,EN_CRC,16BIT_CRC,????,??????
	NRF24L01_CE_HIGH();//CE??,10us?????
  HAL_Delay(1);
}
 
/**
  * ????: ???NRF24L01???????
  * ????: ?
  * ? ? ?: ?
  * ?    ?:?
  *           
  */
void NRF_LowPower_Mode(void)
{
	NRF24L01_CE_LOW();	 
	NRF24L01_Write_Reg(NRF_WRITE_REG+CONFIG, 0x00);		//??????:????
}
